result=$(az vm list-skus --location ${var.location} --query "[?name=='${var.vm_size}' && locationInfo[0].zones != null]" -o json)

# Extract the 'zones' field using jq
zones=$(echo "$result" | jq -r '.[0].locationInfo[0].zones | select(length > 0)')

if [ -z "$zones" ]; then
  echo "No capacity available for ${var.vm_size} in ${var.location}. Halting deployment."
  exit 1
else
  echo "Capacity available for ${var.vm_size} in ${var.location}. Proceeding with deployment."
fi


resource "null_resource" "check_vm_allocation" {
  provisioner "local-exec" {
    command = <<EOT
      echo "Checking Azure capacity for VM size: ${var.vm_size} in region: ${var.location}..."
      result=$(az vm list-skus --location ${var.location} --query "[?name=='${var.vm_size}' && locationInfo[0].zones != null]" -o json)

      zones=$(echo "$result" | jq -r '.[0].locationInfo[0].zones | select(length > 0)')
      
      if [ -z "$zones" ]; then
        echo "No capacity available for ${var.vm_size} in ${var.location}. Halting deployment."
        exit 1
      else
        echo "Capacity available for ${var.vm_size} in ${var.location}. Proceeding with deployment."
      fi
    EOT
  }
}
