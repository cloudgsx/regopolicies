from azure.identity import DefaultAzureCredential
from azure.mgmt.policyinsights import PolicyInsightsClient
import logging
import pandas as pd

# Initialize logging
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# Initialize credentials
credential = DefaultAzureCredential()
policy_insights_client = PolicyInsightsClient(credential)

def get_policy_compliance_for_management_group(management_group_name):
    """Get compliance data for a management group."""
    try:
        logger.info(f"Fetching compliance data for management group: {management_group_name}")

        # Summarize policy compliance for the management group
        results = policy_insights_client.policy_states.summarize_for_management_group(
            management_group_name=management_group_name
        )

        # Extract summary from the results
        compliance_summaries = []
        for summary in results.value:
            compliance_summaries.append({
                "Policy Name": summary.policy_definition_name,
                "Policy ID": summary.policy_definition_id,
                "Total Resources": summary.results.get("totalResources", 0),
                "Compliant Resources": summary.results.get("compliantResources", 0),
                "Non-Compliant Resources": summary.results.get("nonCompliantResources", 0),
            })
        return compliance_summaries
    except Exception as e:
        logger.error(f"Failed to fetch compliance data for management group: {e}")
        return []

def save_to_csv(data, filename="compliance_summary.csv"):
    """Save compliance summary to a CSV file."""
    if not data:
        logger.warning("No data to save.")
        return

    df = pd.DataFrame(data)
    df.to_csv(filename, index=False)
    logger.info(f"Compliance summary saved to {filename}.")

def main():
    MANAGEMENT_GROUP_NAME = "98-root"  # Replace with your management group name

    logger.info("Starting compliance summary generation...")
    compliance_data = get_policy_compliance_for_management_group(MANAGEMENT_GROUP_NAME)

    if compliance_data:
        # Print a summary to the console
        print("\nCompliance Summary:")
        print(pd.DataFrame(compliance_data))

        # Save to a CSV file
        save_to_csv(compliance_data)
    else:
        logger.warning("No compliance data found.")

if __name__ == "__main__":
    main()
