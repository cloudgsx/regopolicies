from azure.identity import DefaultAzureCredential
from azure.mgmt.policyinsights import PolicyInsightsClient
import logging
import pandas as pd

# Set up logging
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# Authenticate using DefaultAzureCredential
credential = DefaultAzureCredential()
policy_insights_client = PolicyInsightsClient(credential)

def get_management_group_compliance(management_group_name):
    """
    Fetch compliance data for all policies assigned to a management group.
    """
    try:
        logger.info(f"Fetching compliance data for management group: {management_group_name}")

        # Summarize compliance at the management group level
        summaries = policy_insights_client.policy_states.summarize_for_management_group(
            management_group_name=management_group_name
        )

        # Parse compliance summaries
        compliance_data = []
        for summary in summaries.value:
            compliance_data.append({
                "Policy Name": summary.policy_definition_name,
                "Policy ID": summary.policy_definition_id,
                "Total Resources": summary.results.get("totalResources", 0),
                "Compliant Resources": summary.results.get("compliantResources", 0),
                "Non-Compliant Resources": summary.results.get("nonCompliantResources", 0)
            })

        return compliance_data

    except Exception as e:
        logger.error(f"Error fetching compliance data: {e}")
        return []

def save_to_csv(data, filename="compliance_summary.csv"):
    """
    Save the compliance data to a CSV file.
    """
    if not data:
        logger.warning("No data to save.")
        return

    df = pd.DataFrame(data)
    df.to_csv(filename, index=False)
    logger.info(f"Compliance summary saved to {filename}.")

def main():
    MANAGEMENT_GROUP_NAME = "98-root"  # Replace with your management group name

    logger.info("Starting compliance summary generation...")
    compliance_data = get_management_group_compliance(MANAGEMENT_GROUP_NAME)

    if compliance_data:
        # Print a summary to the console
        print("\nCompliance Summary:")
        print(pd.DataFrame(compliance_data))

        # Save to a CSV file
        save_to_csv(compliance_data)
    else:
        logger.warning("No compliance data found.")

if __name__ == "__main__":
    main()
