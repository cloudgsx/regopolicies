1. OPA Policy (NSG Rule Validation)

package terraform.azure.nsg

# Input: Terraform plan file
import input.planned_values as tfplan

# Define rules to deny invalid NSG configurations
deny[msg] {
    nsg_rule := tfplan.root_module.resources[_]
    nsg_rule.type == "azurerm_network_security_rule"
    not valid_nsg_rule(nsg_rule)
    msg := sprintf("Invalid NSG rule configuration for %v. Ensure no source address prefix is '0.0.0.0/0' for open access.", [nsg_rule.values.name])
}

# Validate NSG rule configuration
valid_nsg_rule(rule) {
    not open_access(rule.values.source_address_prefix)
}

# Open access check
open_access(source_prefix) {
    source_prefix == "0.0.0.0/0"
}


2. Mock Terraform Plan JSON

{
  "planned_values": {
    "root_module": {
      "resources": [
        {
          "type": "azurerm_network_security_rule",
          "name": "valid_nsg_rule",
          "values": {
            "name": "allow_https_traffic",
            "source_address_prefix": "10.0.0.0/24",
            "destination_port_range": "443",
            "priority": 100
          }
        },
        {
          "type": "azurerm_network_security_rule",
          "name": "invalid_nsg_rule",
          "values": {
            "name": "allow_all_traffic",
            "source_address_prefix": "0.0.0.0/0",
            "destination_port_range": "*",
            "priority": 200
          }
        }
      ]
    }
  }
}


readme

# Azure NSG Rule OPA Policy Validation

## Overview

This repository contains an Open Policy Agent (OPA) policy that validates Azure Network Security Group (NSG) rule configurations in Terraform to ensure security compliance.

---

## Validation Rules

1. **No Open Access**:  
   - The `source_address_prefix` must not be set to `0.0.0.0/0` to prevent overly permissive rules.

---

## Policy File: `nsg_rule_validation.rego`

This policy checks for open access NSG rules and blocks configurations violating the policy.

---

## How to Use

1. **Install OPA**:  
   Follow instructions here: [OPA Installation Guide](https://www.openpolicyagent.org/docs/latest/install/).

2. **Generate Terraform Plan JSON**:  
   Run the following commands:  
   ```bash
   terraform plan -out=tfplan.binary
   terraform show -json tfplan.binary > tfplan.json


evaluate
opa eval --format pretty -i tfplan.json -d nsg_rule_validation.rego "data.terraform.azure.nsg.deny"


output

Invalid NSG rule configuration for allow_all_traffic. Ensure no source address prefix is '0.0.0.0/0' for open access.
