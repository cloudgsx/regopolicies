import json
import re
import subprocess
from tabulate import tabulate

# Path to the uploaded file
file_path = "./roles"

def extract_crd_roles(file_path):
    with open(file_path, 'r') as file:
        content = file.read()
    # Use regex to find role names starting with crd_
    role_names = re.findall(r'name\s*=\s*"([^"]*crd_[^"]*)"', content)
    return role_names

def get_role_definitions(role_names):
    role_data = []
    for role_name in role_names:
        try:
            # Run Azure CLI command to get role definition
            result = subprocess.check_output(
                f'az role definition list --name {role_name}',
                shell=True, text=True
            )
            definitions = json.loads(result)
            for definition in definitions:
                role_data.append([
                    definition["roleName"],
                    definition["id"],
                    definition["description"]
                ])
        except Exception as e:
            print(f"Error fetching role definition for {role_name}: {e}")
    return role_data

def print_table(data):
    if not data:
        print("No roles found.")
        return
    
    headers = ["Name", "Id", "Description"]
    print(tabulate(data, headers=headers, tablefmt="grid"))

# Main script logic
role_names = extract_crd_roles(file_path)
if not role_names:
    print("No roles found in the file.")
else:
    role_definitions = get_role_definitions(role_names)
    print_table(role_definitions)
