import json
import os
import matplotlib.pyplot as plt

def visualize_usage(input_dir):
    """Generate bar charts for resource usage vs. limits across subscriptions."""
    for report_file in os.listdir(input_dir):
        if report_file.endswith(".json"):
            subscription_id = report_file.split("_")[-1].replace(".json", "")
            with open(os.path.join(input_dir, report_file), "r") as f:
                data = json.load(f)

                for region, resources in data.items():
                    if isinstance(resources, list):
                        names = [res["resource_name"] for res in resources]
                        usage = [res["current_usage"] for res in resources]
                        limits = [res["limit"] for res in resources]

                        # Plot
                        plt.figure(figsize=(10, 6))
                        plt.bar(names, usage, label="Current Usage")
                        plt.bar(names, limits, alpha=0.5, label="Limit")
                        plt.title(f"Resource Usage vs Limit - {subscription_id} ({region})")
                        plt.xticks(rotation=45, ha="right")
                        plt.ylabel("Count")
                        plt.legend()
                        plt.tight_layout()

                        # Save the chart
                        plt.savefig(f"usage_vs_limit_{subscription_id}_{region}.png")
                        plt.close()
                        print(f"Chart saved for {subscription_id} - {region}")

if __name__ == "__main__":
    input_directory = "vm_quota_usage_reports"
    visualize_usage(input_directory)
