package terraform.azure.dns

# Deny rules for DNS configuration
deny[msg] {
    zone := input.planned_values.root_module.resources[_]
    zone.type == "azurerm_dns_zone"
    not valid_dns_zone(zone)
    msg := sprintf("Invalid DNS zone configuration: %v", [zone.values.name])
}

# Function to validate DNS zone names and resource group organization
valid_dns_zone(zone) {
    # Validate zone name matches the expected pattern
    re_match("^[a-z0-9-]+\\.(prod|staging|dev)\\.company\\.com$", zone.values.name)

    # Validate resource group follows the expected naming convention
    zone.values.resource_group_name == concat("-", [zone.values.tags.environment, "dns-rg"])
}


========
mock

{
  "planned_values": {
    "root_module": {
      "resources": [
        {
          "type": "azurerm_dns_zone",
          "values": {
            "name": "example.prod.company.com",
            "tags": {
              "environment": "prod"
            },
            "resource_group_name": "prod-dns-rg"
          }
        }
      ]
    }
  }
}

===

readme.md

# Azure DNS Zone Validation OPA Policy

This repository contains an OPA Rego policy to validate Terraform configurations for Azure DNS zones. It enforces naming conventions, resource group organization, and compliance with security standards.

---

## **Policy Rules**

### **Validation Rules**
1. **DNS Zone Name**: Must match the pattern `<subdomain>.<environment>.company.com`.
   - Example: `example.prod.company.com`
2. **Resource Group Name**: Must follow the format `<environment>-dns-rg`.
   - Example: `prod-dns-rg`

### **Deny Conditions**
The policy will deny configurations that:
- Have DNS zone names not following the expected pattern.
- Have resource group names not adhering to naming conventions.

---

## **Mock Testing**

### **Test Valid DNS Zone Configuration**
You can use the following mock input to validate the policy:

```json
{
  "planned_values": {
    "root_module": {
      "resources": [
        {
          "type": "azurerm_dns_zone",
          "values": {
            "name": "example.prod.company.com",
            "tags": {
              "environment": "prod"
            },
            "resource_group_name": "prod-dns-rg"
          }
        }
      ]
    }
  }
}

