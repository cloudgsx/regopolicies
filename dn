package terraform.azure.dns

# Deny rules for DNS configuration
deny[output] {
    zone := input.planned_values.root_module.resources[_]
    zone.type == "azurerm_dns_zone"
    not valid_dns_zone(zone)

    output := {
        "name": zone.values.name,
        "resource_group": zone.values.resource_group_name,
        "error": "Invalid DNS zone configuration"
    }
}

# Convert deny to an array explicitly
deny_list := [output | output = data.terraform.azure.dns.deny[_]]

# Function to validate DNS zone names and resource group organization
valid_dns_zone(zone) {
    re_match("^[a-z0-9-]+\\.(prod|staging|dev)\\.company\\.com$", zone.values.name)
    zone.values.resource_group_name == concat("-", [zone.values.tags.environment, "dns-rg"])
}
