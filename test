result=$(az vm list-skus --location eastus --query "[?name=='Standard_M416ms_v2' && locationInfo[0].zones != null]" -o json)

restricted=$(echo "$result" | jq -r '.[].restrictions[]? | select(.reasonCode=="NotAvailableForSubscription")')

if [ -n "$restricted" ]; then
  echo "VM size Standard_M416ms_v2 is not available for subscription in eastus. Halting deployment."
  exit 1
fi

zones=$(echo "$result" | jq -r '.[0].locationInfo[0].zones | select(length > 0)')

if [ -z "$zones" ]; then
  echo "No capacity available for Standard_M416ms_v2 in eastus. Halting deployment."
  exit 1
else
  echo "Capacity available for Standard_M416ms_v2 in eastus. Proceeding with deployment."
fi


resource "null_resource" "check_vm_allocation" {
  provisioner "local-exec" {
    command = <<EOT
      echo "Checking Azure capacity and subscription for VM size: ${var.vm_size} in region: ${var.location}..."
      result=$(az vm list-skus --location ${var.location} --query "[?name=='${var.vm_size}' && locationInfo[0].zones != null]" -o json)

      restricted=$(echo "$result" | jq -r '.[].restrictions[]? | select(.reasonCode=="NotAvailableForSubscription")')

      if [ -n "$restricted" ]; then
        echo "VM size ${var.vm_size} is not available for subscription in ${var.location}. Halting deployment."
        exit 1
      fi

      zones=$(echo "$result" | jq -r '.[0].locationInfo[0].zones | select(length > 0)')

      if [ -z "$zones" ]; then
        echo "No capacity available for ${var.vm_size} in ${var.location}. Halting deployment."
        exit 1
      else
        echo "Capacity available for ${var.vm_size} in ${var.location}. Proceeding with deployment."
      fi
    EOT
  }
}
